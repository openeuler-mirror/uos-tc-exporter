# 代码结构优化 - 架构重构

## 概述

本次重构将原本职责过多的 `Server` 结构体拆分为多个专门的结构体，遵循单一职责原则，提高代码的可维护性和可扩展性。

## 重构前的问题

### 原始 `Server` 结构体职责过多
- 配置管理
- 指标管理
- HTTP服务器管理
- 中间件处理
- 日志管理
- 信号处理

这违反了单一职责原则，导致：
- 代码耦合度高
- 难以测试
- 难以扩展
- 维护困难

## 重构后的架构

### 1. ConfigManager - 配置管理器
**职责**：专门负责配置管理
- 配置文件加载和解析
- 配置验证
- 配置热重载
- 配置监控

**位置**：`internal/server/config_manager.go`

**主要方法**：
- `NewConfigManager()` - 创建配置管理器
- `LoadConfig()` - 加载配置
- `GetConfig()` - 获取当前配置
- `StartWatching()` - 启动配置监控
- `StopWatching()` - 停止配置监控

### 2. MetricsManager - 指标管理器
**职责**：专门负责指标管理
- Prometheus注册表管理
- 指标收集器注册
- 指标配置重载

**位置**：`internal/server/metrics_manager.go`

**主要方法**：
- `NewMetricsManager()` - 创建指标管理器
- `Setup()` - 设置指标注册表
- `GetRegistry()` - 获取Prometheus注册表
- `Reload()` - 重新加载指标配置

### 3. HttpServer - HTTP服务器管理器
**职责**：专门负责HTTP服务器管理
- HTTP服务器配置
- 中间件管理
- 路由处理
- 着陆页设置

**位置**：`internal/server/http_server.go`

**主要方法**：
- `NewHttpServer()` - 创建HTTP服务器
- `Setup()` - 设置HTTP服务器
- `Run()` - 启动HTTP服务器
- `Stop()` - 停止HTTP服务器
- `Use()` - 添加中间件处理器

### 4. Server - 协调器
**职责**：作为主要协调器，整合各个组件
- 组件生命周期管理
- 组件间协调
- 信号处理
- 版本信息

**位置**：`internal/server/server.go`

**主要方法**：
- `NewServer()` - 创建服务器实例
- `SetUp()` - 初始化所有组件
- `Run()` - 启动服务器
- `Stop()` - 停止服务器
- `Exit()` - 退出处理

## 架构优势

### 1. 单一职责原则
每个结构体都有明确的职责，不会出现职责混乱的情况。

### 2. 高内聚低耦合
- 各组件内部功能紧密相关
- 组件间通过明确的接口交互
- 减少不必要的依赖

### 3. 易于测试
- 每个组件可以独立测试
- 可以轻松模拟依赖组件
- 测试覆盖更容易

### 4. 易于扩展
- 新增功能只需修改相关组件
- 不影响其他组件的稳定性
- 支持插件化架构

### 5. 易于维护
- 代码结构清晰
- 问题定位更容易
- 修改影响范围可控

## 并发安全性

重构后的架构保持了原有的并发安全性：
- `HttpServer` 中的 `handlers` 切片仍然使用读写锁保护
- 各组件内部的状态管理都有适当的并发控制
- 组件间的交互通过线程安全的方法进行

## 配置热重载

配置热重载功能得到保留和优化：
- `ConfigManager` 负责配置监控和重载
- 配置变更时自动通知相关组件
- 支持优雅的配置更新

## 使用示例

```go
// 创建服务器
server := NewServer("tc-exporter", "1.0.0")

// 设置和启动
if err := server.SetUp(); err != nil {
    log.Fatal(err)
}

// 运行
if err := server.Run(); err != nil {
    log.Fatal(err)
}

// 优雅关闭
server.Stop()
```

## 迁移指南

### 对于现有代码
- 原有的 `Server` 接口保持不变
- 内部实现已经重构，但对外行为一致
- 无需修改调用方代码

### 对于新功能开发
- 根据功能类型选择相应的组件
- 遵循组件的职责边界
- 通过 `Server` 进行组件协调

## 总结

通过这次重构，我们实现了：
1. **职责分离**：每个组件都有明确的职责
2. **代码复用**：组件可以在不同场景下复用
3. **易于维护**：代码结构清晰，易于理解和修改
4. **易于测试**：每个组件可以独立测试
5. **易于扩展**：新功能可以轻松集成到现有架构中

这种架构设计为项目的长期发展奠定了良好的基础。
